<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Prof Dali Nadjib - مولد جداول استعمال الزمن</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .neon-border {
            border: 2px solid transparent;
            background: linear-gradient(45deg, #00f5ff, #ff00ea) border-box;
            border-radius: 12px;
        }
        
        .schedule-table {
            border-collapse: collapse;
            width: 100%;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
        }
        
        .schedule-table th, .schedule-table td {
            border: 2px solid #2d3748;
            padding: 10px;
            text-align: center;
            color: #1a202c;
            min-height: 50px;
            position: relative;
            font-weight: 600;
        }
        
        .schedule-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        /* مواد عادية */
        .subject-cell {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #1a202c;
            font-weight: 700;
            border: 2px solid #4299e1;
        }
        
        /* جداول الأساتذة */
        .teacher-cell {
            background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%);
            color: #1a202c;
            font-weight: 700;
            border: 2px solid #805ad5;
        }
        
        /* حصص الاستدراك */
        .remedial-cell {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            color: #1a202c;
            font-weight: 700;
            border: 3px solid #f6ad55;
        }
        
        /* الأيام البيداغوجية */
        .pedagogical-cell {
            background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%);
            color: #1a202c;
            font-weight: 700;
            border: 2px solid #ed8936;
        }
        
        /* الأعمال الموجهة */
        .guided-work-cell {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            color: white;
            font-weight: 700;
            border: 3px solid #e53e3e;
            position: relative;
        }
        
        /* الأعمال التطبيقية */
        .practical-work-cell {
            background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
            color: white;
            font-weight: 700;
            border: 3px solid #9333ea;
        }
        
        /* خانات فارغة */
        .empty-cell {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            color: #718096;
            font-style: italic;
        }
        
        /* تقسيم الخانات للأعمال الموجهة والتطبيقية */
        .split-cell {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 0;
        }
        
        .split-half {
            flex: 1;
            padding: 8px 4px;
            text-align: center;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .split-top {
            border-bottom: 2px solid white;
        }
        
        .btn-neon {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-neon:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 25px rgba(102, 126, 234, 0.6);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #00b894, #00cec9);
            box-shadow: 0 0 20px rgba(0, 184, 148, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #e17055, #fd79a8);
            box-shadow: 0 0 20px rgba(225, 112, 85, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #fdcb6e, #e84393);
            box-shadow: 0 0 20px rgba(253, 203, 110, 0.4);
        }
        
        .input-neon {
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.25);
            color: white;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .input-neon:focus {
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.5);
        }
        
        .input-neon::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .developer-profile {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .profile-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .profile-img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #667eea;
            margin-bottom: 8px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .legend-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .legend-color {
            width: 25px;
            height: 25px;
            border-radius: 6px;
            margin-left: 10px;
            border: 2px solid #333;
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
            100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
        }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            .glass-card { background: white !important; backdrop-filter: none !important; }
            .developer-profile { display: none !important; }
        }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #667eea;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* تحسين الألوان للنص المقروء */
        .header-text {
            color: #e2e8f0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .republic-text {
            color: #cbd5e0;
            font-weight: 600;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body class="min-h-screen text-white">
    <!-- Developer Profile Card -->
    <div class="developer-profile no-print">
        <div class="profile-card">
            <img src="https://pfst.cf2.poecdn.net/base/image/43ac593f28526a0c6d665a79ddf535cdc1a80d403c662d42de1f3f47d2233f5b?w=1024&h=1536" 
                 alt="Prof Dali Nadjib" class="profile-img">
            <div class="text-xs text-white font-bold">Prof Dali Nadjib</div>
            <div class="text-xs text-gray-300">AI Developer</div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="text-center mb-8 fade-in">
            <div class="glass-card rounded-2xl p-8 neon-border">
                <h1 class="text-5xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent mb-4">
                    🎓 AI Prof Dali Nadjib
                </h1>
                <p class="text-2xl header-text mb-3">
                    مولد جداول استعمال الزمن الذكي
                </p>
                <p class="text-lg header-text mb-2">
                    للمؤسسات التعليمية المتوسطة
                </p>
                <p class="text-lg republic-text font-bold">
                    🇩🇿 الجمهورية الجزائرية الديمقراطية الشعبية 🇩🇿
                </p>
                <div class="mt-4 flex justify-center items-center space-x-4 space-x-reverse">
                    <div class="w-2 h-2 bg-green-400 rounded-full pulse"></div>
                    <span class="text-green-400 text-sm font-bold">نظام ذكي متطور - وفق القوانين الجزائرية</span>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex flex-wrap justify-center mb-8 space-x-2 space-x-reverse no-print">
            <button onclick="showTab('setup')" id="setupTab" 
                    class="px-6 py-3 btn-neon rounded-lg mx-1 mb-2 transition-all duration-300">
                ⚙️ إعداد البيانات
            </button>
            <button onclick="showTab('schedules')" id="schedulesTab" 
                    class="px-6 py-3 bg-gray-700 text-gray-300 rounded-lg mx-1 mb-2 hover:bg-gray-600 transition-all duration-300">
                📊 الجداول المولدة
            </button>
            <button onclick="showTab('analytics')" id="analyticsTab" 
                    class="px-6 py-3 bg-gray-700 text-gray-300 rounded-lg mx-1 mb-2 hover:bg-gray-600 transition-all duration-300">
                📈 التحليلات والإحصائيات
            </button>
        </div>

        <!-- Setup Tab -->
        <div id="setupContent" class="tab-content">
            <!-- Institution Info -->
            <div class="glass-card rounded-2xl p-8 mb-8 fade-in">
                <h2 class="text-3xl font-bold text-center mb-8 bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">
                    🏫 معلومات المؤسسة
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <label class="block text-lg font-semibold text-gray-300 mb-2">اسم المؤسسة</label>
                        <input type="text" id="institutionName" 
                               class="w-full px-4 py-3 text-lg input-neon" 
                               placeholder="متوسطة الشهيد...">
                    </div>
                    <div>
                        <label class="block text-lg font-semibold text-gray-300 mb-2">العام الدراسي</label>
                        <input type="text" id="academicYear" value="2024-2025"
                               class="w-full px-4 py-3 text-lg input-neon">
                    </div>
                </div>

                <!-- Classes Distribution -->
                <div class="mb-8">
                    <h3 class="text-2xl font-bold text-center mb-6 text-cyan-400">📚 توزيع الأقسام حسب المستوى</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="glass-card p-6 rounded-xl">
                            <label class="block text-lg font-semibold text-gray-300 mb-3">السنة الأولى متوسط</label>
                            <input type="number" id="level1Classes" min="0" max="10" value="5"
                                   class="w-full px-4 py-3 text-xl text-center input-neon font-bold"
                                   onchange="updateClassTotals()">
                        </div>
                        <div class="glass-card p-6 rounded-xl">
                            <label class="block text-lg font-semibold text-gray-300 mb-3">السنة الثانية متوسط</label>
                            <input type="number" id="level2Classes" min="0" max="10" value="4"
                                   class="w-full px-4 py-3 text-xl text-center input-neon font-bold"
                                   onchange="updateClassTotals()">
                        </div>
                        <div class="glass-card p-6 rounded-xl">
                            <label class="block text-lg font-semibold text-gray-300 mb-3">السنة الثالثة متوسط</label>
                            <input type="number" id="level3Classes" min="0" max="10" value="3"
                                   class="w-full px-4 py-3 text-xl text-center input-neon font-bold"
                                   onchange="updateClassTotals()">
                        </div>
                        <div class="glass-card p-6 rounded-xl">
                            <label class="block text-lg font-semibold text-gray-300 mb-3">السنة الرابعة متوسط</label>
                            <input type="number" id="level4Classes" min="0" max="10" value="1"
                                   class="w-full px-4 py-3 text-xl text-center input-neon font-bold"
                                   onchange="updateClassTotals()">
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <div class="inline-block glass-card px-8 py-4 rounded-xl">
                            <span class="text-xl text-gray-300">إجمالي الأقسام: </span>
                            <span id="totalClasses" class="text-3xl font-bold text-cyan-400">13</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="text-center mb-8">
                    <div class="flex flex-wrap justify-center gap-4">
                        <button onclick="loadMyInstitution()" 
                                class="px-8 py-4 btn-success rounded-xl text-lg font-bold transition-all duration-300 pulse">
                            🏫 تحميل بيانات مؤسستي
                        </button>
                        <button onclick="resetAllData()" 
                                class="px-8 py-4 btn-danger rounded-xl text-lg font-bold transition-all duration-300">
                            🔄 إعادة تعيين شامل
                        </button>
                    </div>
                </div>
            </div>

            <!-- Teachers Management -->
            <div class="glass-card rounded-2xl p-8 mb-8 fade-in">
                <h2 class="text-3xl font-bold text-center mb-8 bg-gradient-to-r from-green-400 to-blue-500 bg-clip-text text-transparent">
                    👨‍🏫 إدارة الأساتذة والمواد
                </h2>
                
                <!-- Add Teacher Form -->
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6">
                    <div>
                        <input type="text" id="teacherName" 
                               class="w-full px-4 py-3 input-neon" 
                               placeholder="اسم الأستاذ">
                    </div>
                    <div>
                        <select id="teacherSubject" class="w-full px-4 py-3 input-neon">
                            <option value="">اختر المادة</option>
                            <option value="رياضيات">رياضيات</option>
                            <option value="اللغة العربية">اللغة العربية</option>
                            <option value="اللغة الفرنسية">اللغة الفرنسية</option>
                            <option value="اللغة الإنجليزية">اللغة الإنجليزية</option>
                            <option value="العلوم الطبيعية">العلوم الطبيعية</option>
                            <option value="العلوم الفيزيائية">العلوم الفيزيائية</option>
                            <option value="التاريخ والجغرافيا">التاريخ والجغرافيا</option>
                            <option value="التربية المدنية">التربية المدنية</option>
                            <option value="التربية الإسلامية">التربية الإسلامية</option>
                            <option value="التربية البدنية">التربية البدنية</option>
                            <option value="الإعلام الآلي">الإعلام الآلي</option>
                            <option value="التربية الفنية">التربية الفنية</option>
                        </select>
                    </div>
                    <div>
                        <input type="text" id="assignedClasses" 
                               class="w-full px-4 py-3 input-neon" 
                               placeholder="الأقسام (مثل: 1م1,2م1)">
                    </div>
                    <div>
                        <input type="number" id="totalHours" min="1" max="22" 
                               class="w-full px-4 py-3 input-neon" 
                               placeholder="إجمالي الساعات">
                    </div>
                    <div>
                        <select id="pedagogicalDay" class="w-full px-4 py-3 input-neon">
                            <option value="">اليوم البيداغوجي</option>
                            <option value="الأحد">الأحد</option>
                            <option value="الاثنين">الاثنين</option>
                            <option value="الثلاثاء">الثلاثاء</option>
                            <option value="الأربعاء">الأربعاء</option>
                            <option value="الخميس">الخميس</option>
                        </select>
                    </div>
                    <div>
                        <button onclick="addTeacher()" 
                                class="w-full px-4 py-3 btn-success rounded-lg font-bold transition-all duration-300">
                            ➕ إضافة
                        </button>
                    </div>
                </div>

                <!-- Teachers Table -->
                <div class="overflow-x-auto">
                    <table class="w-full schedule-table">
                        <thead>
                            <tr>
                                <th>الأستاذ</th>
                                <th>المادة</th>
                                <th>الأقسام المسندة</th>
                                <th>إجمالي الساعات</th>
                                <th>اليوم البيداغوجي</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="teachersTableBody">
                            <!-- Teachers will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Generation Controls -->
            <div class="glass-card rounded-2xl p-8 fade-in">
                <h2 class="text-3xl font-bold text-center mb-8 bg-gradient-to-r from-purple-400 to-pink-500 bg-clip-text text-transparent">
                    🚀 توليد الجداول
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <button onclick="generateInstitutionSchedule()" 
                            class="px-6 py-4 btn-neon rounded-xl text-lg font-bold transition-all duration-300">
                        🏫 جدول المؤسسة
                    </button>
                    <button onclick="generateStudentSchedules()" 
                            class="px-6 py-4 btn-warning rounded-xl text-lg font-bold transition-all duration-300">
                        📚 جداول التلاميذ
                    </button>
                    <button onclick="generateTeacherSchedules()" 
                            class="px-6 py-4 btn-success rounded-xl text-lg font-bold transition-all duration-300">
                        👨‍🏫 جداول الأساتذة
                    </button>
                    <button onclick="generateAllSchedules()" 
                            class="px-6 py-4 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl text-lg font-bold transition-all duration-300 pulse">
                        ⚡ توليد جميع الجداول
                    </button>
                </div>

                <!-- Loading Animation -->
                <div id="loadingSection" class="hidden text-center py-8">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-xl text-gray-300">جاري توليد الجداول الذكية...</p>
                    <p class="text-sm text-gray-400">تطبيق خوارزميات الذكاء الاصطناعي والقوانين التنظيمية الجزائرية المحدثة</p>
                </div>
            </div>
        </div>

        <!-- Schedules Tab -->
        <div id="schedulesContent" class="tab-content hidden">
            <div class="glass-card rounded-2xl p-8 fade-in">
                <h2 class="text-3xl font-bold text-center mb-8 bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">
                    📊 الجداول المولدة
                </h2>
                
                <!-- Color Legend -->
                <div class="legend-card mb-8">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">🎨 مفاتيح الألوان (محدث)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="legend-item">
                            <div class="legend-color subject-cell"></div>
                            <span class="text-white">حصص عادية</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color guided-work-cell"></div>
                            <span class="text-white">أعمال موجهة (تفويج)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color practical-work-cell"></div>
                            <span class="text-white">أعمال تطبيقية (ساعتان)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color remedial-cell"></div>
                            <span class="text-white">حصص الاستدراك (مساءً)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color pedagogical-cell"></div>
                            <span class="text-white">أيام بيداغوجية</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color teacher-cell"></div>
                            <span class="text-white">جداول الأساتذة</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color empty-cell"></div>
                            <span class="text-white">فراغات (تم تجنبها)</span>
                        </div>
                        <div class="legend-item">
                            <div style="width: 25px; height: 25px; background: linear-gradient(to bottom, #ff6b6b 50%, #4299e1 50%); border: 2px solid #333; border-radius: 6px; margin-left: 10px;"></div>
                            <span class="text-white">تفويج (ف1/ف2)</span>
                        </div>
                    </div>
                    
                    <!-- Important Notes -->
                    <div class="mt-6 p-4 bg-blue-500 bg-opacity-20 rounded-lg">
                        <h4 class="text-white font-bold mb-2">📋 ملاحظات مهمة:</h4>
                        <ul class="text-white text-sm space-y-1">
                            <li>• حصص الاستدراك: حصة واحدة أسبوعياً لكل أستاذ (يجمع جميع أقسامه)</li>
                            <li>• الأعمال التطبيقية: ساعتان مدمجتان (علوم طبيعية + فيزيائية)</li>
                            <li>• يوم الثلاثاء: نصف يوم عمل (8:00-12:00)</li>
                            <li>• لا توجد فراغات في جداول التلاميذ</li>
                            <li>• التوزيع يراعي عدم تكرار المادة أكثر من مرتين يومياً</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Schedule Type Selector -->
                <div class="text-center mb-8">
                    <div class="inline-flex rounded-xl overflow-hidden border border-gray-600">
                        <button onclick="showScheduleType('institution')" id="institutionBtn"
                                class="px-6 py-3 btn-neon border-0 rounded-none">
                            🏫 جدول المؤسسة
                        </button>
                        <button onclick="showScheduleType('students')" id="studentsBtn"
                                class="px-6 py-3 bg-gray-700 text-gray-300 border-0 rounded-none hover:bg-gray-600">
                            📚 جداول التلاميذ
                        </button>
                        <button onclick="showScheduleType('teachers')" id="teachersBtn"
                                class="px-6 py-3 bg-gray-700 text-gray-300 border-0 rounded-none hover:bg-gray-600">
                            👨‍🏫 جداول الأساتذة
                        </button>
                    </div>
                </div>

                <!-- Export Controls -->
                <div class="text-center mb-8 no-print">
                    <div class="flex flex-wrap justify-center gap-4">
                        <button onclick="exportToPDF()" 
                                class="px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all duration-300">
                            📄 تصدير PDF
                        </button>
                        <button onclick="exportToWord()" 
                                class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-all duration-300">
                            📝 تصدير Word
                        </button>
                        <button onclick="printSchedule()" 
                                class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-all duration-300">
                            🖨️ طباعة
                        </button>
                    </div>
                </div>

                <!-- Schedule Display Areas -->
                <div id="institutionScheduleDisplay" class="schedule-display">
                    <div class="text-center text-gray-400 py-12">
                        <h3 class="text-2xl mb-4">🏫 جدول المؤسسة</h3>
                        <p>لم يتم توليد جدول المؤسسة بعد</p>
                        <p class="text-sm">اضغط على زر "توليد جميع الجداول" في إعداد البيانات</p>
                    </div>
                </div>

                <div id="studentsScheduleDisplay" class="schedule-display hidden">
                    <div class="text-center mb-6">
                        <select id="classSelector" class="px-4 py-2 input-neon rounded-lg">
                            <option value="">اختر القسم</option>
                        </select>
                    </div>
                    <div id="studentScheduleContent" class="text-center text-gray-400 py-12">
                        <h3 class="text-2xl mb-4">📚 جداول التلاميذ</h3>
                        <p>اختر قسماً من القائمة أعلاه</p>
                    </div>
                </div>

                <div id="teachersScheduleDisplay" class="schedule-display hidden">
                    <div class="text-center mb-6">
                        <select id="teacherSelector" class="px-4 py-2 input-neon rounded-lg">
                            <option value="">اختر الأستاذ</option>
                        </select>
                    </div>
                    <div id="teacherScheduleContent" class="text-center text-gray-400 py-12">
                        <h3 class="text-2xl mb-4">👨‍🏫 جداول الأساتذة</h3>
                        <p>اختر أستاذاً من القائمة أعلاه</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analyticsContent" class="tab-content hidden">
            <div class="glass-card rounded-2xl p-8 fade-in">
                <h2 class="text-3xl font-bold text-center mb-8 bg-gradient-to-r from-green-400 to-purple-500 bg-clip-text text-transparent">
                    📈 التحليلات والإحصائيات
                </h2>
                
                <div id="analyticsDisplay" class="text-center text-gray-400 py-12">
                    <h3 class="text-2xl mb-4">📊 إحصائيات المؤسسة</h3>
                    <p>لم يتم توليد الإحصائيات بعد</p>
                    <p class="text-sm">قم بتوليد الجداول أولاً لعرض التحليلات</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let teachers = [];
        let institutionData = {};
        let generatedSchedules = {
            institution: null,
            students: {},
            teachers: {},
            analytics: null
        };

        // Time Configuration (Algerian Middle School System)
        const timeSlots = [
            '08:00-09:00',
            '09:00-10:00', 
            '10:00-11:00',
            '11:00-12:00',
            '13:00-14:00',  // بداية المساء
            '14:00-15:00',
            '15:00-16:00'   // حصة الاستدراك المسائية
        ];

        const morningSlots = ['08:00-09:00', '09:00-10:00', '10:00-11:00', '11:00-12:00'];
        const afternoonSlots = ['13:00-14:00', '14:00-15:00', '15:00-16:00'];
        const remedialSlot = '15:00-16:00'; // حصة الاستدراك المسائية
        const tuesdaySlots = ['08:00-09:00', '09:00-10:00', '10:00-11:00', '11:00-12:00']; // الثلاثاء نصف يوم

        const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس'];

        // Subject Hours per Level (Algerian Curriculum 2024-2025)
        const subjectHours = {
            'اللغة العربية': [5, 5, 5, 5],
            'اللغة الفرنسية': [4, 4, 4, 4],
            'اللغة الإنجليزية': [2, 2, 2, 2],
            'رياضيات': [5, 5, 5, 6], // سنة رابعة 6 ساعات
            'العلوم الطبيعية': [2, 2, 2, 2],
            'العلوم الفيزيائية': [2, 2, 2, 2],
            'التاريخ والجغرافيا': [2, 2, 2, 2],
            'التربية الإسلامية': [1, 1, 1, 0],
            'التربية المدنية': [1, 1, 1, 0],
            'الإعلام الآلي': [2, 2, 2, 0],
            'التربية الفنية': [0, 0, 0, 2],
            'التربية البدنية': [2, 2, 2, 2]
        };

        // Main subjects for remedial classes - NOW ONE SESSION PER TEACHER PER WEEK
        const remedialSchedule = {
            'اللغة العربية': 'الأحد',
            'اللغة الفرنسية': 'الاثنين', 
            'رياضيات': 'الأربعاء',
            'اللغة الإنجليزية': 'الخميس'
        };

        // Guided work subjects (أعمال موجهة)
        const guidedWorkPairs = {
            'عربية_رياضيات': ['اللغة العربية', 'رياضيات'],
            'فرنسية_إنجليزية': ['اللغة الفرنسية', 'اللغة الإنجليزية']
        };

        // Practical work subjects (أعمال تطبيقية) - NOW 2 HOURS COMBINED
        const practicalWorkSubjects = ['العلوم الطبيعية', 'العلوم الفيزيائية'];

        // Pedagogical Days Configuration
        const pedagogicalDays = {
            'الأحد': ['التاريخ والجغرافيا', 'التربية المدنية'],
            'الاثنين': ['اللغة العربية', 'التربية الإسلامية'],
            'الثلاثاء': ['اللغة الفرنسية', 'اللغة الإنجليزية', 'التربية البدنية', 'الإعلام الآلي'],
            'الأربعاء': ['العلوم الطبيعية', 'العلوم الفيزيائية'],
            'الخميس': ['رياضيات', 'التربية الفنية']
        };

        // My Institution Data
        const myInstitutionTeachers = [
            // رياضيات
            { name: 'دالي نجيب', subject: 'رياضيات', classes: ['1م1', '1م2', '2م1', '2م2'], hours: 20, pedagogicalDay: 'الخميس' },
            { name: 'بن بارش منيرة', subject: 'رياضيات', classes: ['1م3', '1م4', '2م3'], hours: 15, pedagogicalDay: 'الخميس' },
            { name: 'رقيق رمزي', subject: 'رياضيات', classes: ['1م5', '3م1', '3م2', '4م1'], hours: 20, pedagogicalDay: 'الخميس' },
            
            // اللغة العربية
            { name: 'مروة', subject: 'اللغة العربية', classes: ['1م1', '1م2', '2م1'], hours: 15, pedagogicalDay: 'الاثنين' },
            { name: 'صبرينة', subject: 'اللغة العربية', classes: ['1م3', '2م2', '2م3'], hours: 15, pedagogicalDay: 'الاثنين' },
            { name: 'آسيا', subject: 'اللغة العربية', classes: ['1م4', '1م5', '3م1'], hours: 15, pedagogicalDay: 'الاثنين' },
            { name: 'زينب', subject: 'اللغة العربية', classes: ['3م2', '3م3', '4م1'], hours: 15, pedagogicalDay: 'الاثنين' },
            { name: 'سعيدة', subject: 'اللغة العربية', classes: ['2م4'], hours: 5, pedagogicalDay: 'الاثنين' },
            
            // فرنسية
            { name: 'العيد', subject: 'اللغة الفرنسية', classes: ['1م1', '1م2', '1م3', '2م1', '2م2'], hours: 20, pedagogicalDay: 'الثلاثاء' },
            { name: 'سارة', subject: 'اللغة الفرنسية', classes: ['1م4', '1م5', '2م3', '2م4'], hours: 16, pedagogicalDay: 'الثلاثاء' },
            { name: 'سلمى', subject: 'اللغة الفرنسية', classes: ['3م1', '3م2', '3م3', '4م1'], hours: 16, pedagogicalDay: 'الثلاثاء' },
            
            // إنجليزية
            { name: 'بوبكر', subject: 'اللغة الإنجليزية', classes: ['1م1', '1م2', '1م3', '1م4', '2م1', '2م2'], hours: 12, pedagogicalDay: 'الثلاثاء' },
            { name: 'هشام', subject: 'اللغة الإنجليزية', classes: ['1م5', '2م3', '2م4', '3م1', '3م2'], hours: 10, pedagogicalDay: 'الثلاثاء' },
            { name: 'أمينة', subject: 'اللغة الإنجليزية', classes: ['3م3', '4م1'], hours: 4, pedagogicalDay: 'الثلاثاء' },
            
            // علوم طبيعية
            { name: 'وسيلة', subject: 'العلوم الطبيعية', classes: ['1م1', '1م2', '1م3', '2م1', '2م2', '3م1', '3م2'], hours: 14, pedagogicalDay: 'الأربعاء' },
            { name: 'فتيحة', subject: 'العلوم الطبيعية', classes: ['1م4', '1م5', '2م3', '2م4', '3م3', '4م1'], hours: 12, pedagogicalDay: 'الأربعاء' },
            
            // تاريخ وجغرافيا
            { name: 'وداد', subject: 'التاريخ والجغرافيا', classes: ['1م1', '1م2', '1م3', '2م1', '2م2'], hours: 10, pedagogicalDay: 'الأحد' },
            { name: 'عائشة', subject: 'التاريخ والجغرافيا', classes: ['1م4', '1م5', '2م3', '2م4'], hours: 8, pedagogicalDay: 'الأحد' },
            { name: 'فاطمة', subject: 'التاريخ والجغرافيا', classes: ['3م1', '3م2', '3م3', '4م1'], hours: 8, pedagogicalDay: 'الأحد' },
            
            // علوم فيزيائية
            { name: 'عبد الرزاق', subject: 'العلوم الفيزيائية', classes: ['1م1', '1م2', '1م3', '2م1', '2م2'], hours: 10, pedagogicalDay: 'الأربعاء' },
            { name: 'بلوطار', subject: 'العلوم الفيزيائية', classes: ['1م4', '1م5', '2م3', '2م4'], hours: 8, pedagogicalDay: 'الأربعاء' },
            { name: 'شيماء', subject: 'العلوم الفيزيائية', classes: ['3م1', '3م2', '3م3', '4م1'], hours: 8, pedagogicalDay: 'الأربعاء' },
            
            // رياضة
            { name: 'علاء', subject: 'التربية البدنية', classes: ['1م1', '1م2', '1م3', '2م1', '2م2', '3م1', '3م2'], hours: 14, pedagogicalDay: 'الثلاثاء' },
            { name: 'خير الدين', subject: 'التربية البدنية', classes: ['1م4', '1م5', '2م3', '2م4', '3م3', '4م1'], hours: 12, pedagogicalDay: 'الثلاثاء' },
            
            // تربية إسلامية
            { name: 'سهام', subject: 'التربية الإسلامية', classes: ['1م1', '1م2', '1م3', '1م4', '1م5', '2م1', '2م2', '2م3', '2م4', '3م1', '3م2', '3م3'], hours: 12, pedagogicalDay: 'الاثنين' },
            
            // إعلام آلي
            { name: 'شهرة', subject: 'الإعلام الآلي', classes: ['1م1', '1م2', '1م3', '1م4', '1م5', '2م1', '2م2', '2م3', '2م4', '3م1', '3م2', '3م3'], hours: 24, pedagogicalDay: 'الثلاثاء' },
            
            // رسم
            { name: 'سيف', subject: 'التربية الفنية', classes: ['4م1'], hours: 2, pedagogicalDay: 'الخميس' }
        ];

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            showTab('setup');
            updateClassTotals();
        });

        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            document.querySelectorAll('[id$="Tab"]').forEach(tab => {
                tab.className = tab.className.replace('btn-neon', 'bg-gray-700 text-gray-300').replace('transition-all duration-300', 'hover:bg-gray-600 transition-all duration-300');
            });

            document.getElementById(tabName + 'Content').classList.remove('hidden');
            
            const activeTab = document.getElementById(tabName + 'Tab');
            activeTab.className = activeTab.className.replace('bg-gray-700 text-gray-300 hover:bg-gray-600', 'btn-neon');
        }

        // Update class totals
        function updateClassTotals() {
            const level1 = parseInt(document.getElementById('level1Classes').value) || 0;
            const level2 = parseInt(document.getElementById('level2Classes').value) || 0;
            const level3 = parseInt(document.getElementById('level3Classes').value) || 0;
            const level4 = parseInt(document.getElementById('level4Classes').value) || 0;
            
            const total = level1 + level2 + level3 + level4;
            document.getElementById('totalClasses').textContent = total;
        }

        // Teacher management functions
        function addTeacher() {
            const name = document.getElementById('teacherName').value.trim();
            const subject = document.getElementById('teacherSubject').value;
            const classes = document.getElementById('assignedClasses').value.trim();
            const hours = parseInt(document.getElementById('totalHours').value);
            const pedagogicalDay = document.getElementById('pedagogicalDay').value;

            if (!name || !subject || !classes || !hours) {
                showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }

            const teacher = {
                id: Date.now(),
                name,
                subject,
                classes: classes.split(',').map(c => c.trim()),
                hours,
                pedagogicalDay
            };

            teachers.push(teacher);
            updateTeachersTable();
            clearTeacherForm();
            showNotification('تم إضافة الأستاذ بنجاح', 'success');
        }

        function updateTeachersTable() {
            const tbody = document.getElementById('teachersTableBody');
            tbody.innerHTML = '';

            teachers.forEach(teacher => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="teacher-cell">${teacher.name}</td>
                    <td class="subject-cell">${teacher.subject}</td>
                    <td contenteditable="true" class="editable-cell" 
                        onblur="updateTeacherClasses(${teacher.id}, this.textContent)">${teacher.classes.join(', ')}</td>
                    <td contenteditable="true" class="editable-cell" 
                        onblur="updateTeacherHours(${teacher.id}, this.textContent)">${teacher.hours}</td>
                    <td class="pedagogical-cell">${teacher.pedagogicalDay || '-'}</td>
                    <td>
                        <button onclick="editTeacher(${teacher.id})" 
                                class="px-2 py-1 bg-blue-500 text-white rounded mr-2 text-sm">
                            ✏️ تعديل
                        </button>
                        <button onclick="deleteTeacher(${teacher.id})" 
                                class="px-2 py-1 bg-red-500 text-white rounded text-sm">
                            🗑️ حذف
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateTeacherClasses(teacherId, newClasses) {
            const teacher = teachers.find(t => t.id === teacherId);
            if (teacher) {
                teacher.classes = newClasses.split(',').map(c => c.trim());
                showNotification('تم تحديث الأقسام', 'success');
            }
        }

        function updateTeacherHours(teacherId, newHours) {
            const teacher = teachers.find(t => t.id === teacherId);
            if (teacher) {
                teacher.hours = parseInt(newHours) || 0;
                showNotification('تم تحديث الساعات', 'success');
            }
        }

        function editTeacher(teacherId) {
            const teacher = teachers.find(t => t.id === teacherId);
            if (!teacher) return;

            document.getElementById('teacherName').value = teacher.name;
            document.getElementById('teacherSubject').value = teacher.subject;
            document.getElementById('assignedClasses').value = teacher.classes.join(', ');
            document.getElementById('totalHours').value = teacher.hours;
            document.getElementById('pedagogicalDay').value = teacher.pedagogicalDay || '';

            deleteTeacher(teacherId);
        }

        function deleteTeacher(teacherId) {
            showConfirmDialog('هل أنت متأكد من حذف هذا الأستاذ؟', () => {
                teachers = teachers.filter(t => t.id !== teacherId);
                updateTeachersTable();
                showNotification('تم حذف الأستاذ', 'success');
            });
        }

        function clearTeacherForm() {
            document.getElementById('teacherName').value = '';
            document.getElementById('teacherSubject').value = '';
            document.getElementById('assignedClasses').value = '';
            document.getElementById('totalHours').value = '';
            document.getElementById('pedagogicalDay').value = '';
        }

        function loadMyInstitution() {
            document.getElementById('institutionName').value = 'متوسطة الشهيد الطاهر دريسي';
            
            teachers = [...myInstitutionTeachers.map(t => ({
                ...t,
                id: Date.now() + Math.random()
            }))];
            
            updateTeachersTable();
            showNotification('تم تحميل بيانات مؤسستي بنجاح! 🎉', 'success');
        }

        function resetAllData() {
            showConfirmDialog('هل أنت متأكد من إعادة تعيين جميع البيانات؟', () => {
                teachers = [];
                generatedSchedules = { institution: null, students: {}, teachers: {}, analytics: null };
                
                document.getElementById('institutionName').value = '';
                document.getElementById('academicYear').value = '2024-2025';
                document.getElementById('level1Classes').value = '5';
                document.getElementById('level2Classes').value = '4';
                document.getElementById('level3Classes').value = '3';
                document.getElementById('level4Classes').value = '1';
                updateClassTotals();
                
                clearTeacherForm();
                updateTeachersTable();
                
                showNotification('تم إعادة تعيين جميع البيانات', 'success');
            });
        }

        // IMPROVED SCHEDULING ALGORITHM - NO GAPS FOR STUDENTS
        function generateAllSchedules() {
            showLoading();
            setTimeout(() => {
                try {
                    const allClasses = generateClassList();
                    const masterSchedule = createImprovedMasterSchedule(allClasses);
                    
                    generatedSchedules.institution = masterSchedule.institution;
                    generatedSchedules.students = masterSchedule.students;
                    generatedSchedules.teachers = masterSchedule.teachers;
                    generatedSchedules.analytics = createAdvancedAnalytics();
                    
                    updateClassSelector();
                    updateTeacherSelector();
                    
                    hideLoading();
                    showNotification('تم توليد جميع الجداول بنجاح! ⚡', 'success');
                    showTab('schedules');
                } catch (error) {
                    hideLoading();
                    showNotification('حدث خطأ في توليد الجداول', 'error');
                    console.error(error);
                }
            }, 3000);
        }

        // IMPROVED MASTER SCHEDULE CREATION
        function createImprovedMasterSchedule(allClasses) {
            const masterSchedule = {
                institution: {},
                students: {},
                teachers: {}
            };

            // Initialize all schedules
            allClasses.forEach(className => {
                masterSchedule.students[className] = initializeEmptySchedule();
            });

            teachers.forEach(teacher => {
                masterSchedule.teachers[teacher.name] = initializeEmptySchedule();
                applyPedagogicalDays(masterSchedule.teachers[teacher.name], teacher);
            });

            // Step 1: Schedule all regular subjects ensuring NO GAPS for students
            allClasses.forEach(className => {
                fillStudentScheduleCompletely(className, masterSchedule);
            });

            // Step 2: Schedule guided work
            allClasses.forEach(className => {
                scheduleGuidedWorkForClass(className, masterSchedule);
            });

            // Step 3: Schedule practical work (2 hours combined)
            allClasses.forEach(className => {
                schedulePracticalWorkForClass(className, masterSchedule);
            });

            // Step 4: Schedule global remedial sessions (one per teacher per week)
            scheduleGlobalRemedialSessions(masterSchedule);

            // Step 5: Optimize teacher schedules to minimize gaps
            optimizeAllTeacherSchedules(masterSchedule);

            // Step 6: Create institution overview
            masterSchedule.institution = createInstitutionOverview(masterSchedule);

            return masterSchedule;
        }

        function initializeEmptySchedule() {
            const schedule = {};
            days.forEach(day => {
                schedule[day] = {};
                const daySlots = day === 'الثلاثاء' ? tuesdaySlots : timeSlots;
                daySlots.forEach(slot => {
                    schedule[day][slot] = {
                        subject: '',
                        teacher: '',
                        type: 'empty',
                        content: ''
                    };
                });
            });
            return schedule;
        }

        function applyPedagogicalDays(schedule, teacher) {
            const freeDaySubjects = pedagogicalDays[teacher.pedagogicalDay] || [];
            
            if (freeDaySubjects.includes(teacher.subject)) {
                const daySlots = teacher.pedagogicalDay === 'الثلاثاء' ? tuesdaySlots : timeSlots;
                daySlots.forEach(slot => {
                    if (slot !== remedialSlot) { // Keep remedial slot available
                        schedule[teacher.pedagogicalDay][slot] = {
                            subject: 'يوم بيداغوجي',
                            teacher: '',
                            type: 'pedagogical',
                            content: 'فراغ - يوم بيداغوجي'
                        };
                    }
                });
            }
        }

        // FILL STUDENT SCHEDULE COMPLETELY - NO GAPS ALLOWED
        function fillStudentScheduleCompletely(className, masterSchedule) {
            const level = parseInt(className.charAt(0)) - 1;
            const studentSchedule = masterSchedule.students[className];
            
            // Get all available slots for this class
            const allAvailableSlots = [];
            days.forEach(day => {
                const daySlots = day === 'الثلاثاء' ? tuesdaySlots : timeSlots.filter(slot => slot !== remedialSlot);
                daySlots.forEach(slot => {
                    allAvailableSlots.push({ day, slot });
                });
            });

            // Shuffle slots for randomization
            const shuffledSlots = allAvailableSlots.sort(() => Math.random() - 0.5);

            // Collect all subjects that need to be scheduled
            const subjectsToSchedule = [];
            Object.keys(subjectHours).forEach(subject => {
                const hoursNeeded = subjectHours[subject][level];
                if (hoursNeeded > 0) {
                    const teacher = teachers.find(t => 
                        t.subject === subject && t.classes.includes(className)
                    );
                    
                    if (teacher) {
                        for (let i = 0; i < hoursNeeded; i++) {
                            subjectsToSchedule.push({
                                subject: subject,
                                teacher: teacher.name,
                                priority: getPriorityForSubject(subject)
                            });
                        }
                    }
                }
            });

            // Sort subjects by priority and shuffle within same priority
            subjectsToSchedule.sort((a, b) => {
                if (a.priority !== b.priority) {
                    return b.priority - a.priority; // Higher priority first
                }
                return Math.random() - 0.5; // Random within same priority
            });

            // Schedule subjects to fill all available slots
            let slotIndex = 0;
            const subjectDailyCount = {};

            subjectsToSchedule.forEach(subjectData => {
                let scheduled = false;
                let attempts = 0;
                
                while (!scheduled && attempts < shuffledSlots.length) {
                    const { day, slot } = shuffledSlots[slotIndex % shuffledSlots.length];
                    slotIndex++;
                    attempts++;

                    // Check if this slot is available and constraints are met
                    if (canScheduleSubjectHere(studentSchedule, masterSchedule, className, 
                                              subjectData.subject, subjectData.teacher, day, slot, subjectDailyCount)) {
                        
                        // Schedule the subject
                        studentSchedule[day][slot] = {
                            subject: subjectData.subject,
                            teacher: subjectData.teacher,
                            type: 'regular',
                            content: `${subjectData.subject}\n${subjectData.teacher}`
                        };

                        // Update teacher schedule
                        if (masterSchedule.teachers[subjectData.teacher][day][slot].type === 'empty') {
                            masterSchedule.teachers[subjectData.teacher][day][slot] = {
                                subject: subjectData.subject,
                                teacher: className,
                                type: 'teaching',
                                content: `${subjectData.subject} - ${className}`
                            };
                        }

                        // Update daily count
                        const key = `${day}_${subjectData.subject}`;
                        subjectDailyCount[key] = (subjectDailyCount[key] || 0) + 1;
                        
                        scheduled = true;
                    }
                }
            });

            // Fill any remaining empty slots with available subjects
            fillRemainingSlots(studentSchedule, masterSchedule, className, level);
        }

        function getPriorityForSubject(subject) {
            const priorities = {
                'رياضيات': 10,
                'اللغة العربية': 10,
                'اللغة الفرنسية': 9,
                'اللغة الإنجليزية': 8,
                'العلوم الطبيعية': 7,
                'العلوم الفيزيائية': 7,
                'التاريخ والجغرافيا': 6,
                'التربية الإسلامية': 5,
                'التربية المدنية': 5,
                'الإعلام الآلي': 4,
                'التربية البدنية': 3,
                'التربية الفنية': 2
            };
            return priorities[subject] || 1;
        }

        function canScheduleSubjectHere(studentSchedule, masterSchedule, className, subject, teacherName, day, slot, subjectDailyCount) {
            // Check if student slot is available
            if (studentSchedule[day][slot].type !== 'empty') {
                return false;
            }

            // Check if teacher is available
            if (masterSchedule.teachers[teacherName][day][slot].type !== 'empty') {
                return false;
            }

            // Check daily limit for this subject (max 2 times per day)
            const key = `${day}_${subject}`;
            if ((subjectDailyCount[key] || 0) >= 2) {
                return false;
            }

            // Check for consecutive lessons (try to avoid)
            const slotIndex = timeSlots.indexOf(slot);
            if (slotIndex > 0) {
                const prevSlot = timeSlots[slotIndex - 1];
                if (studentSchedule[day][prevSlot] && studentSchedule[day][prevSlot].subject === subject) {
                    return false; // Avoid consecutive lessons
                }
            }

            return true;
        }

        function fillRemainingSlots(studentSchedule, masterSchedule, className, level) {
            // Find any remaining empty slots and fill them with available subjects
            days.forEach(day => {
                const daySlots = day === 'الثلاثاء' ? tuesdaySlots : timeSlots.filter(slot => slot !== remedialSlot);
                
                daySlots.forEach(slot => {
                    if (studentSchedule[day][slot].type === 'empty') {
                        // Find an available subject for this slot
                        const availableSubjects = Object.keys(subjectHours).filter(subject => {
                            if (subjectHours[subject][level] === 0) return false;
                            
                            const teacher = teachers.find(t => 
                                t.subject === subject && t.classes.includes(className)
                            );
                            
                            return teacher && masterSchedule.teachers[teacher.name][day][slot].type === 'empty';
                        });

                        if (availableSubjects.length > 0) {
                            // Pick a random available subject
                            const randomSubject = availableSubjects[Math.floor(Math.random() * availableSubjects.length)];
                            const teacher = teachers.find(t => 
                                t.subject === randomSubject && t.classes.includes(className)
                            );

                            studentSchedule[day][slot] = {
                                subject: randomSubject,
                                teacher: teacher.name,
                                type: 'regular',
                                content: `${randomSubject}\n${teacher.name}`
                            };

                            masterSchedule.teachers[teacher.name][day][slot] = {
                                subject: randomSubject,
                                teacher: className,
                                type: 'teaching',
                                content: `${randomSubject} - ${className}`
                            };
                        }
                    }
                });
            });
        }

        function scheduleGuidedWorkForClass(className, masterSchedule) {
            const level = parseInt(className.charAt(0)) - 1;
            const studentSchedule = masterSchedule.students[className];
            
            if (level < 3) {
                // For levels 1-3: combined guided work
                scheduleGuidedWorkPair(className, 'عربية_رياضيات', studentSchedule, masterSchedule);
                scheduleGuidedWorkPair(className, 'فرنسية_إنجليزية', studentSchedule, masterSchedule);
            } else if (level === 3) {
                // For level 4: separate guided work sessions
                scheduleLevel4GuidedWork(className, studentSchedule, masterSchedule);
            }
        }

        function scheduleGuidedWorkPair(className, pairKey, studentSchedule, masterSchedule) {
            const subjects = guidedWorkPairs[pairKey];
            const teacher1 = teachers.find(t => t.subject === subjects[0] && t.classes.includes(className));
            const teacher2 = teachers.find(t => t.subject === subjects[1] && t.classes.includes(className));

            if (!teacher1 || !teacher2) return;

            // Find a slot where we can replace a regular lesson with guided work
            for (const day of days) {
                if (day === 'الثلاثاء') continue; // Skip Tuesday for guided work
                
                const daySlots = timeSlots.filter(slot => slot !== remedialSlot);
                
                for (const slot of daySlots) {
                    const currentCell = studentSchedule[day][slot];
                    
                    // Check if this slot has one of the subjects in the pair
                    if (currentCell.type === 'regular' && 
                        (currentCell.subject === subjects[0] || currentCell.subject === subjects[1]) &&
                        masterSchedule.teachers[teacher1.name][day][slot].type !== 'pedagogical' &&
                        masterSchedule.teachers[teacher2.name][day][slot].type !== 'pedagogical') {

                        // Replace with guided work
                        studentSchedule[day][slot] = {
                            subject: `أعمال موجهة`,
                            teacher: `${teacher1.name} / ${teacher2.name}`,
                            type: 'guided-work',
                            content: '',
                            split: {
                                top: `ف1 ${subjects[0]}`,
                                bottom: `ف2 ${subjects[1]}`
                            }
                        };

                        // Update both teacher schedules
                        masterSchedule.teachers[teacher1.name][day][slot] = {
                            subject: `أعمال موجهة ${subjects[0]}`,
                            teacher: className,
                            type: 'guided-work',
                            content: `أ.م ${subjects[0]} - ${className} (ف1)`
                        };

                        masterSchedule.teachers[teacher2.name][day][slot] = {
                            subject: `أعمال موجهة ${subjects[1]}`,
                            teacher: className,
                            type: 'guided-work',
                            content: `أ.م ${subjects[1]} - ${className} (ف2)`
                        };

                        return; // Only one guided work session per pair
                    }
                }
            }
        }

        function scheduleLevel4GuidedWork(className, studentSchedule, masterSchedule) {
            const arabicTeacher = teachers.find(t => t.subject === 'اللغة العربية' && t.classes.includes(className));
            const mathTeacher = teachers.find(t => t.subject === 'رياضيات' && t.classes.includes(className));

            if (!arabicTeacher || !mathTeacher) return;

            // Find two consecutive slots to replace with guided work
            for (const day of days) {
                if (day === 'الثلاثاء') continue;
                
                const daySlots = timeSlots.filter(slot => slot !== remedialSlot);
                
                for (let i = 0; i < daySlots.length - 1; i++) {
                    const slot1 = daySlots[i];
                    const slot2 = daySlots[i + 1];

                    const cell1 = studentSchedule[day][slot1];
                    const cell2 = studentSchedule[day][slot2];

                    // Check if we can use these slots for guided work
                    if ((cell1.subject === 'اللغة العربية' || cell1.subject === 'رياضيات') &&
                        (cell2.subject === 'اللغة العربية' || cell2.subject === 'رياضيات') &&
                        masterSchedule.teachers[arabicTeacher.name][day][slot1].type !== 'pedagogical' &&
                        masterSchedule.teachers[mathTeacher.name][day][slot2].type !== 'pedagogical') {

                        // Schedule Arabic guided work (ف1)
                        studentSchedule[day][slot1] = {
                            subject: 'أعمال موجهة (ف1 عربية)',
                            teacher: arabicTeacher.name,
                            type: 'guided-work',
                            content: `أ.م عربية - ف1\n${arabicTeacher.name}`
                        };

                        masterSchedule.teachers[arabicTeacher.name][day][slot1] = {
                            subject: 'أعمال موجهة عربية',
                            teacher: className,
                            type: 'guided-work',
                            content: `أ.م عربية - ${className} (ف1)`
                        };

                        // Schedule Math guided work (ف2)
                        studentSchedule[day][slot2] = {
                            subject: 'أعمال موجهة (ف2 رياضيات)',
                            teacher: mathTeacher.name,
                            type: 'guided-work',
                            content: `أ.م رياضيات - ف2\n${mathTeacher.name}`
                        };

                        masterSchedule.teachers[mathTeacher.name][day][slot2] = {
                            subject: 'أعمال موجهة رياضيات',
                            teacher: className,
                            type: 'guided-work',
                            content: `أ.م رياضيات - ${className} (ف2)`
                        };

                        return; // Done with guided work for this class
                    }
                }
            }
        }

        // PRACTICAL WORK - 2 HOURS COMBINED IN ONE CELL
        function schedulePracticalWorkForClass(className, masterSchedule) {
            const level = parseInt(className.charAt(0)) - 1;
            const studentSchedule = masterSchedule.students[className];
            
            const scienceTeacher = teachers.find(t => t.subject === 'العلوم الطبيعية' && t.classes.includes(className));
            const physicsTeacher = teachers.find(t => t.subject === 'العلوم الفيزيائية' && t.classes.includes(className));

            if (!scienceTeacher || !physicsTeacher) return;

            // Find a 2-hour slot (consecutive periods) to replace with practical work
            for (const day of days) {
                if (day === 'الثلاثاء') continue; // Skip Tuesday
                
                const daySlots = timeSlots.filter(slot => slot !== remedialSlot);
                
                for (let i = 0; i < daySlots.length - 1; i++) {
                    const slot1 = daySlots[i];
                    const slot2 = daySlots[i + 1];

                    const cell1 = studentSchedule[day][slot1];
                    const cell2 = studentSchedule[day][slot2];

                    // Check if we can use these two consecutive slots
                    if ((cell1.subject === 'العلوم الطبيعية' || cell1.subject === 'العلوم الفيزيائية') &&
                        (cell2.subject === 'العلوم الطبيعية' || cell2.subject === 'العلوم الفيزيائية') &&
                        masterSchedule.teachers[scienceTeacher.name][day][slot1].type !== 'pedagogical' &&
                        masterSchedule.teachers[physicsTeacher.name][day][slot1].type !== 'pedagogical') {

                        // Combine both slots into one practical work session
                        studentSchedule[day][slot1] = {
                            subject: 'أعمال تطبيقية (ساعتان)',
                            teacher: `${scienceTeacher.name} / ${physicsTeacher.name}`,
                            type: 'practical-work',
                            content: '',
                            split: {
                                top: 'علوم طبيعية',
                                bottom: 'علوم فيزيائية'
                            }
                        };

                        // Second slot continues the practical work
                        studentSchedule[day][slot2] = {
                            subject: 'أعمال تطبيقية (تتمة)',
                            teacher: `${scienceTeacher.name} / ${physicsTeacher.name}`,
                            type: 'practical-work',
                            content: 'تتمة الأعمال التطبيقية'
                        };

                        // Update teacher schedules for both slots
                        masterSchedule.teachers[scienceTeacher.name][day][slot1] = {
                            subject: 'أعمال تطبيقية علوم',
                            teacher: className,
                            type: 'practical-work',
                            content: `أ.ت علوم - ${className} (ساعة 1)`
                        };

                        masterSchedule.teachers[scienceTeacher.name][day][slot2] = {
                            subject: 'أعمال تطبيقية علوم',
                            teacher: className,
                            type: 'practical-work',
                            content: `أ.ت علوم - ${className} (ساعة 2)`
                        };

                        masterSchedule.teachers[physicsTeacher.name][day][slot1] = {
                            subject: 'أعمال تطبيقية فيزياء',
                            teacher: className,
                            type: 'practical-work',
                            content: `أ.ت فيزياء - ${className} (ساعة 1)`
                        };

                        masterSchedule.teachers[physicsTeacher.name][day][slot2] = {
                            subject: 'أعمال تطبيقية فيزياء',
                            teacher: className,
                            type: 'practical-work',
                            content: `أ.ت فيزياء - ${className} (ساعة 2)`
                        };

                        return; // Only one practical work session per class
                    }
                }
            }
        }

        // GLOBAL REMEDIAL SESSIONS - ONE PER TEACHER PER WEEK
        function scheduleGlobalRemedialSessions(masterSchedule) {
            Object.entries(remedialSchedule).forEach(([subject, day]) => {
                const subjectTeachers = teachers.filter(t => t.subject === subject);
                
                subjectTeachers.forEach(teacher => {
                    if (masterSchedule.teachers[teacher.name][day] && 
                        masterSchedule.teachers[teacher.name][day][remedialSlot] &&
                        masterSchedule.teachers[teacher.name][day][remedialSlot].type === 'empty') {
                        
                        // Schedule remedial for teacher (combines all their classes)
                        masterSchedule.teachers[teacher.name][day][remedialSlot] = {
                            subject: `استدراك ${subject}`,
                            teacher: `جميع الأقسام المسندة`,
                            type: 'remedial',
                            content: `استدراك ${subject} - ${teacher.classes.join(', ')}`
                        };

                        // Add remedial to all classes taught by this teacher
                        teacher.classes.forEach(className => {
                            if (masterSchedule.students[className] && 
                                masterSchedule.students[className][day] &&
                                masterSchedule.students[className][day][remedialSlot] &&
                                masterSchedule.students[className][day][remedialSlot].type === 'empty') {
                                
                                masterSchedule.students[className][day][remedialSlot] = {
                                    subject: `استدراك ${subject}`,
                                    teacher: teacher.name,
                                    type: 'remedial',
                                    content: `استدراك ${subject}\n${teacher.name}\n(التلاميذ الضعفاء)`
                                };
                            }
                        });
                    }
                });
            });
        }

        function optimizeAllTeacherSchedules(masterSchedule) {
            teachers.forEach(teacher => {
                optimizeTeacherSchedule(masterSchedule.teachers[teacher.name], teacher);
            });
        }

        function optimizeTeacherSchedule(teacherSchedule, teacher) {
            // Try to minimize gaps by rearranging non-pedagogical classes
            days.forEach(day => {
                if (day === teacher.pedagogicalDay) return; // Skip pedagogical day

                const daySlots = day === 'الثلاثاء' ? tuesdaySlots : timeSlots;
                const classes = [];
                
                // Collect all teaching activities for this day
                daySlots.forEach(slot => {
                    const activity = teacherSchedule[day][slot];
                    if (activity.type === 'teaching' || 
                        activity.type === 'guided-work' ||
                        activity.type === 'practical-work' ||
                        activity.type === 'remedial') {
                        classes.push({
                            slot: slot,
                            data: activity
                        });
                        // Clear the slot temporarily
                        teacherSchedule[day][slot] = {
                            subject: '',
                            teacher: '',
                            type: 'empty',
                            content: ''
                        };
                    }
                });

                // Redistribute classes to minimize gaps
                if (classes.length > 0) {
                    // Try to group classes together
                    let currentSlotIndex = 0;
                    classes.forEach(classData => {
                        while (currentSlotIndex < daySlots.length && 
                               teacherSchedule[day][daySlots[currentSlotIndex]].type !== 'empty') {
                            currentSlotIndex++;
                        }
                        
                        if (currentSlotIndex < daySlots.length) {
                            teacherSchedule[day][daySlots[currentSlotIndex]] = classData.data;
                            currentSlotIndex++;
                        }
                    });
                }
            });
        }

        function createInstitutionOverview(masterSchedule) {
            const overview = {};
            
            days.forEach(day => {
                overview[day] = {};
                const daySlots = day === 'الثلاثاء' ? tuesdaySlots : timeSlots;
                
                daySlots.forEach(slot => {
                    overview[day][slot] = {
                        activities: [],
                        totalActivities: 0
                    };

                    // Count all activities for this time slot
                    Object.keys(masterSchedule.students).forEach(className => {
                        const studentActivity = masterSchedule.students[className][day] && 
                                              masterSchedule.students[className][day][slot];
                        if (studentActivity && studentActivity.type !== 'empty') {
                            overview[day][slot].activities.push({
                                className: className,
                                activity: studentActivity
                            });
                        }
                    });

                    overview[day][slot].totalActivities = overview[day][slot].activities.length;
                });
            });

            return overview;
        }

        // Helper functions
        function generateClassList() {
            const classes = [];
            const levels = [
                parseInt(document.getElementById('level1Classes').value) || 0,
                parseInt(document.getElementById('level2Classes').value) || 0,
                parseInt(document.getElementById('level3Classes').value) || 0,
                parseInt(document.getElementById('level4Classes').value) || 0
            ];

            levels.forEach((count, level) => {
                for (let i = 1; i <= count; i++) {
                    classes.push(`${level + 1}م${i}`);
                }
            });

            return classes;
        }

        // Individual generation functions
        function generateInstitutionSchedule() {
            generateAllSchedules();
        }

        function generateStudentSchedules() {
            generateAllSchedules();
        }

        function generateTeacherSchedules() {
            generateAllSchedules();
        }

        // Analytics
        function createAdvancedAnalytics() {
            const analytics = {
                totalTeachers: teachers.length,
                totalClasses: generateClassList().length,
                subjectDistribution: {},
                teacherWorkload: {},
                gapAnalysis: {},
                remedialSessions: Object.keys(remedialSchedule).length
            };

            // Calculate subject distribution
            teachers.forEach(teacher => {
                if (!analytics.subjectDistribution[teacher.subject]) {
                    analytics.subjectDistribution[teacher.subject] = 0;
                }
                analytics.subjectDistribution[teacher.subject]++;
            });

            // Calculate teacher workload and gaps
            teachers.forEach(teacher => {
                const workload = calculateTeacherWorkload(teacher);
                analytics.teacherWorkload[teacher.name] = workload;
                analytics.gapAnalysis[teacher.name] = analyzeTeacherGaps(teacher);
            });

            return analytics;
        }

        function calculateTeacherWorkload(teacher) {
            if (!generatedSchedules.teachers[teacher.name]) return { total: 0, distribution: {} };

            const schedule = generatedSchedules.teachers[teacher.name];
            let totalHours = 0;
            const distribution = {};

            days.forEach(day => {
                distribution[day] = 0;
                const daySlots = day === 'الثلاثاء' ? tuesdaySlots : timeSlots;
                
                daySlots.forEach(slot => {
                    if (schedule[day] && schedule[day][slot] && 
                        ['teaching', 'guided-work', 'practical-work', 'remedial'].includes(schedule[day][slot].type)) {
                        totalHours++;
                        distribution[day]++;
                    }
                });
            });

            return {
                total: totalHours,
                distribution: distribution,
                efficiency: totalHours <= 20 ? 'مناسب' : 'مكثف',
                percentage: Math.round((totalHours / 20) * 100)
            };
        }

        function analyzeTeacherGaps(teacher) {
            if (!generatedSchedules.teachers[teacher.name]) return { totalGaps: 0, maxConsecutiveGaps: 0 };

            const schedule = generatedSchedules.teachers[teacher.name];
            let totalGaps = 0;
            let maxConsecutiveGaps = 0;

            days.forEach(day => {
                if (day === teacher.pedagogicalDay) return;

                const daySlots = day === 'الثلاثاء' ? tuesdaySlots : timeSlots;
                let consecutiveGaps = 0;
                let hasClassBefore = false;

                daySlots.forEach((slot, index) => {
                    const isClassSlot = schedule[day] && schedule[day][slot] && 
                        ['teaching', 'guided-work', 'practical-work', 'remedial'].includes(schedule[day][slot].type);

                    if (isClassSlot) {
                        if (consecutiveGaps > 0 && hasClassBefore) {
                            totalGaps += consecutiveGaps;
                            maxConsecutiveGaps = Math.max(maxConsecutiveGaps, consecutiveGaps);
                        }
                        consecutiveGaps = 0;
                        hasClassBefore = true;
                    } else if (hasClassBefore && index < daySlots.length - 1) {
                        consecutiveGaps++;
                    }
                });
            });

            return {
                totalGaps: totalGaps,
                maxConsecutiveGaps: maxConsecutiveGaps,
                rating: totalGaps <= 2 ? 'ممتاز' : totalGaps <= 5 ? 'جيد' : 'يحتاج تحسين'
            };
        }

        // Display functions
        function showScheduleType(type) {
            document.querySelectorAll('.schedule-display').forEach(display => {
                display.classList.add('hidden');
            });
            
            document.querySelectorAll('[id$="Btn"]').forEach(btn => {
                btn.className = btn.className.replace('btn-neon', 'bg-gray-700 text-gray-300 hover:bg-gray-600');
            });

            document.getElementById(type + 'ScheduleDisplay').classList.remove('hidden');
            document.getElementById(type + 'Btn').className = document.getElementById(type + 'Btn').className.replace('bg-gray-700 text-gray-300 hover:bg-gray-600', 'btn-neon');

            if (type === 'institution' && generatedSchedules.institution) {
                displayInstitutionSchedule();
            }
        }

        function displayInstitutionSchedule() {
            const display = document.getElementById('institutionScheduleDisplay');
            const institutionName = document.getElementById('institutionName').value || 'المؤسسة';
            const academicYear = document.getElementById('academicYear').value || '2024-2025';
            
            let html = `
                <div class="text-center mb-8">
                    <h3 class="text-3xl font-bold text-white mb-2">${institutionName}</h3>
                    <p class="text-xl text-gray-300">جدول استعمال الزمن العام</p>
                    <p class="text-lg text-gray-400">العام الدراسي: ${academicYear}</p>
                    <p class="text-sm text-gray-500 mt-2">✅ لا توجد فراغات في جداول التلاميذ</p>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="schedule-table">
                        <thead>
                            <tr>
                                <th>التوقيت</th>
                                ${days.map(day => `<th>${day}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;

            timeSlots.forEach(slot => {
                html += `<tr><td class="font-bold">${slot}</td>`;
                days.forEach(day => {
                    if (day === 'الثلاثاء' && !tuesdaySlots.includes(slot)) {
                        html += `<td class="empty-cell">نصف يوم</td>`;
                    } else {
                        const daySchedule = generatedSchedules.institution[day] && generatedSchedules.institution[day][slot];
                        const activities = daySchedule ? daySchedule.totalActivities : 0;
                        
                        if (activities > 0) {
                            html += `<td class="subject-cell">
                                <div class="text-sm font-bold">${activities} نشاط</div>
                                <div class="text-xs">جميع الأقسام نشطة</div>
                            </td>`;
                        } else {
                            html += `<td class="empty-cell">فراغ مؤسسي</td>`;
                        }
                    }
                });
                html += '</tr>';
            });

            html += `
                        </tbody>
                    </table>
                </div>
                
                <!-- Important Remedial Schedule Info -->
                <div class="mt-8 p-4 bg-orange-500 bg-opacity-20 rounded-lg">
                    <h4 class="text-white font-bold mb-3 text-center">📅 جدول حصص الاستدراك (مساءً)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
                        ${Object.entries(remedialSchedule).map(([subject, day]) => `
                            <div class="bg-yellow-500 bg-opacity-30 rounded-lg p-3">
                                <div class="text-white font-bold">${subject}</div>
                                <div class="text-gray-200 text-sm">${day} - ${remedialSlot}</div>
                            </div>
                        `).join('')}
                    </div>
                    <p class="text-white text-sm text-center mt-3">
                        * كل أستاذ يجمع التلاميذ الضعفاء من جميع أقسامه في حصة واحدة أسبوعياً
                    </p>
                </div>
            `;

            display.innerHTML = html;
        }

        function updateClassSelector() {
            const selector = document.getElementById('classSelector');
            selector.innerHTML = '<option value="">اختر القسم</option>';
            
            const allClasses = generateClassList();
            allClasses.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                selector.appendChild(option);
            });
            
            selector.onchange = function() {
                if (this.value) {
                    displayStudentSchedule(this.value);
                }
            };
        }

        function updateTeacherSelector() {
            const selector = document.getElementById('teacherSelector');
            selector.innerHTML = '<option value="">اختر الأستاذ</option>';
            
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.name;
                option.textContent = `${teacher.name} - ${teacher.subject}`;
                selector.appendChild(option);
            });
            
            selector.onchange = function() {
                if (this.value) {
                    displayTeacherSchedule(this.value);
                }
            };
        }

        function displayStudentSchedule(className) {
            const content = document.getElementById('studentScheduleContent');
            const schedule = generatedSchedules.students[className];
            
            if (!schedule) {
                content.innerHTML = '<p class="text-center text-gray-400">لم يتم توليد جدول هذا القسم بعد</p>';
                return;
            }

            let html = `
                <div class="text-center mb-6">
                    <h4 class="text-2xl font-bold text-white mb-2">جدول القسم: ${className}</h4>
                    <p class="text-gray-300">جدول استعمال الزمن الأسبوعي (بدون فراغات)</p>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="schedule-table">
                        <thead>
                            <tr>
                                <th>التوقيت</th>
                                ${days.map(day => `<th>${day}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;

            timeSlots.forEach(slot => {
                html += `<tr><td class="font-bold">${slot}</td>`;
                days.forEach(day => {
                    if (day === 'الثلاثاء' && !tuesdaySlots.includes(slot)) {
                        html += `<td class="empty-cell">نصف يوم</td>`;
                    } else {
                        const cell = schedule[day] && schedule[day][slot];
                        if (cell && cell.type !== 'empty') {
                            let cellClass = 'subject-cell';
                            let content = '';

                            if (cell.type === 'guided-work') {
                                cellClass = 'guided-work-cell';
                                if (cell.split) {
                                    content = `
                                        <div class="split-cell">
                                            <div class="split-half split-top">${cell.split.top}</div>
                                            <div class="split-half">${cell.split.bottom}</div>
                                        </div>
                                    `;
                                } else {
                                    content = `<div class="font-bold text-sm">${cell.subject}</div><div class="text-xs">${cell.teacher}</div>`;
                                }
                            } else if (cell.type === 'practical-work') {
                                cellClass = 'practical-work-cell';
                                if (cell.split) {
                                    content = `
                                        <div class="split-cell">
                                            <div class="split-half split-top">${cell.split.top}</div>
                                            <div class="split-half">${cell.split.bottom}</div>
                                        </div>
                                    `;
                                } else {
                                    content = `<div class="font-bold text-sm">${cell.subject}</div><div class="text-xs">${cell.teacher}</div>`;
                                }
                            } else if (cell.type === 'remedial') {
                                cellClass = 'remedial-cell';
                                content = `<div class="font-bold text-sm">${cell.subject}</div><div class="text-xs">${cell.teacher}</div><div class="text-xs">التلاميذ الضعفاء</div>`;
                            } else {
                                content = `<div class="font-bold text-sm">${cell.subject}</div><div class="text-xs">${cell.teacher}</div>`;
                            }

                            html += `<td class="${cellClass}">${content}</td>`;
                        } else {
                            html += `<td class="empty-cell">فراغ (خطأ)</td>`;
                        }
                    }
                });
                html += '</tr>';
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            content.innerHTML = html;
        }

        function displayTeacherSchedule(teacherName) {
            const content = document.getElementById('teacherScheduleContent');
            const schedule = generatedSchedules.teachers[teacherName];
            const teacher = teachers.find(t => t.name === teacherName);
            
            if (!schedule || !teacher) {
                content.innerHTML = '<p class="text-center text-gray-400">لم يتم توليد جدول هذا الأستاذ بعد</p>';
                return;
            }

            const workload = calculateTeacherWorkload(teacher);
            const gaps = analyzeTeacherGaps(teacher);

            let html = `
                <div class="text-center mb-6">
                    <h4 class="text-2xl font-bold text-white mb-2">الأستاذ: ${teacherName}</h4>
                    <p class="text-gray-300">المادة: ${teacher.subject} | الأقسام: ${teacher.classes.join(', ')}</p>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
                        <div class="bg-blue-500 bg-opacity-20 rounded-lg p-3">
                            <div class="text-white font-bold">${workload.total}</div>
                            <div class="text-gray-300 text-sm">ساعات فعلية</div>
                        </div>
                        <div class="bg-green-500 bg-opacity-20 rounded-lg p-3">
                            <div class="text-white font-bold">${gaps.totalGaps}</div>
                            <div class="text-gray-300 text-sm">إجمالي الفراغات</div>
                        </div>
                        <div class="bg-purple-500 bg-opacity-20 rounded-lg p-3">
                            <div class="text-white font-bold">${workload.efficiency}</div>
                            <div class="text-gray-300 text-sm">تقييم النصاب</div>
                        </div>
                        <div class="bg-orange-500 bg-opacity-20 rounded-lg p-3">
                            <div class="text-white font-bold">${gaps.rating}</div>
                            <div class="text-gray-300 text-sm">تقييم التوزيع</div>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="schedule-table">
                        <thead>
                            <tr>
                                <th>التوقيت</th>
                                ${days.map(day => `<th>${day}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;

            timeSlots.forEach(slot => {
                html += `<tr><td class="font-bold">${slot}</td>`;
                days.forEach(day => {
                    if (day === 'الثلاثاء' && !tuesdaySlots.includes(slot)) {
                        html += `<td class="empty-cell">نصف يوم</td>`;
                    } else {
                        const cell = schedule[day] && schedule[day][slot];
                        if (cell && cell.type !== 'empty') {
                            let cellClass = 'teacher-cell';
                            let content = '';

                            if (cell.type === 'pedagogical') {
                                cellClass = 'pedagogical-cell';
                                content = `<div class="font-bold text-sm">يوم بيداغوجي</div><div class="text-xs">فراغ</div>`;
                            } else if (cell.type === 'guided-work') {
                                cellClass = 'guided-work-cell';
                                content = `<div class="font-bold text-sm">${cell.subject}</div><div class="text-xs">${cell.teacher}</div>`;
                            } else if (cell.type === 'practical-work') {
                                cellClass = 'practical-work-cell';
                                content = `<div class="font-bold text-sm">${cell.subject}</div><div class="text-xs">${cell.teacher}</div>`;
                            } else if (cell.type === 'remedial') {
                                cellClass = 'remedial-cell';
                                content = `<div class="font-bold text-sm">${cell.subject}</div><div class="text-xs">${cell.teacher}</div>`;
                            } else {
                                content = `<div class="font-bold text-sm">${cell.subject}</div><div class="text-xs">${cell.teacher}</div>`;
                            }

                            html += `<td class="${cellClass}">${content}</td>`;
                        } else {
                            html += `<td class="empty-cell">فراغ</td>`;
                        }
                    }
                });
                html += '</tr>';
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            content.innerHTML = html;
        }

        // Export functions
        function exportToPDF() {
            showNotification('ميزة تصدير PDF قيد التطوير المتقدم', 'info');
        }

        function exportToWord() {
            showNotification('ميزة تصدير Word قيد التطوير المتقدم', 'info');
        }

        function printSchedule() {
            window.print();
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loadingSection').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingSection').classList.add('hidden');
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 
                           type === 'error' ? 'bg-red-500' : 
                           type === 'info' ? 'bg-blue-500' : 'bg-gray-500';
            
            notification.className = `fixed top-4 left-4 z-50 p-4 rounded-lg shadow-lg text-white transform transition-all duration-300 ${bgColor}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <span class="ml-2">${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'}</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(-100%)';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        function showConfirmDialog(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="glass-card rounded-xl p-8 max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold text-white mb-4 text-center">تأكيد العملية</h3>
                    <p class="text-gray-300 mb-6 text-center">${message}</p>
                    <div class="flex justify-center space-x-3 space-x-reverse">
                        <button onclick="this.closest('.fixed').remove()" 
                                class="px-6 py-2 bg-gray-600 text-white hover:bg-gray-700 rounded-lg transition-colors">
                            إلغاء
                        </button>
                        <button onclick="this.closest('.fixed').remove(); (${onConfirm})()" 
                                class="px-6 py-2 bg-red-500 text-white hover:bg-red-600 rounded-lg transition-colors">
                            تأكيد
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
    </script>
</body>
</html>
